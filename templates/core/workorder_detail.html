
{% extends 'core/base.html' %}
{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-3">
  <div>
    <div class="d-flex align-items-center gap-2">
      <h3 class="mb-0">{{ order.order_no }}</h3>
      <span class="badge badge-soft">{{ order.get_status_display }}</span>
    </div>
    <div class="small-muted mt-1">
      <i class="bi bi-person me-1"></i>{{ order.vehicle.customer.name }} ({{ order.vehicle.customer.phone }})
      <span class="mx-2">·</span>
      <i class="bi bi-bicycle me-1"></i>{{ order.vehicle.model }}
      <span class="mx-2">·</span>
      <i class="bi bi-calendar-event me-1"></i>입고 {{ order.in_datetime|date:"Y-m-d H:i" }}
    </div>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-light" href="/"><i class="bi bi-arrow-left me-1"></i>목록</a>
    <a class="btn btn-primary" href="/workorders/{{ order.id }}/invoice.pdf"><i class="bi bi-file-earmark-pdf me-1"></i>견적/명세서 PDF</a>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-5">
    <div class="card">
      <div class="card-body p-4">
        <div class="row g-2">
          <div class="col-6"><div class="kpi"><div><div class="label">부품</div><div class="value">{{ order.subtotal_parts|floatformat:0 }}</div></div><div class="small-muted">원</div></div></div>
          <div class="col-6"><div class="kpi"><div><div class="label">공임</div><div class="value">{{ order.subtotal_labor|floatformat:0 }}</div></div><div class="small-muted">원</div></div></div>
          <div class="col-6"><div class="kpi"><div><div class="label">부가세</div><div class="value">{{ order.tax_amount|floatformat:0 }}</div></div><div class="small-muted">원</div></div></div>
          <div class="col-6"><div class="kpi"><div><div class="label">결제 합계</div><div class="value">{{ payments_total|floatformat:0 }}</div></div><div class="small-muted">원</div></div></div>
        </div>

        <div class="mt-3 p-3 rounded-4" style="background: rgba(255,255,255,.03); border: 1px solid rgba(255,255,255,.08);">
          <div class="d-flex justify-content-between align-items-center">
            <div class="small-muted">총액(부가세 포함)</div>
            <div class="fs-4 fw-bold">{{ order.total_amount|floatformat:0 }} <span class="fs-6 fw-normal">원</span></div>
          </div>
        </div>

        <hr class="my-4">

        <div class="mb-3">
          <div class="small-muted mb-1"><i class="bi bi-chat-left-text me-1"></i>고객요청(증상)</div>
          <div>{{ order.customer_complaint|linebreaksbr|default:"-" }}</div>
        </div>
        <div class="mb-3">
          <div class="small-muted mb-1"><i class="bi bi-search me-1"></i>진단</div>
          <div>{{ order.diagnosis|linebreaksbr|default:"-" }}</div>
        </div>
        <div class="mb-0">
          <div class="small-muted mb-1"><i class="bi bi-wrench me-1"></i>작업내용</div>
          <div>{{ order.work_detail|linebreaksbr|default:"-" }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-7">
    <div class="card mb-3">
      <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-box-seam"></i><b>부품/소모품</b>
      </div>
      <div class="card-body p-4">
        <form method="post" action="/workorders/{{ order.id }}/parts/add/" class="row g-2">
          {% csrf_token %}
          <div class="col-md-6">{{ part_form.part_name }}</div>
          <div class="col-md-3">{{ part_form.qty }}</div>
          <div class="col-md-3">{{ part_form.unit_price }}</div>
          <div class="col-12">
            <button class="btn btn-outline-light w-100"><i class="bi bi-plus-lg me-1"></i>부품 추가</button>
          </div>
        </form>

        <hr class="my-4">

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead><tr><th>품목</th><th class="text-end">수량</th><th class="text-end">단가</th><th class="text-end">금액</th></tr></thead>
            <tbody>
            {% for p in order.parts.all %}
              <tr>
                <td class="fw-semibold">{{ p.part_name }}</td>
                <td class="text-end">{{ p.qty }}</td>
                <td class="text-end">{{ p.unit_price|floatformat:0 }}</td>
                <td class="text-end fw-semibold">{{ p.line_total|floatformat:0 }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-center text-muted py-4">부품 내역이 없습니다.</td></tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-stopwatch"></i><b>공임</b>
      </div>
      <div class="card-body p-4">
        <form method="post" action="/workorders/{{ order.id }}/labor/add/" class="row g-2">
          {% csrf_token %}
          <div class="col-md-6">{{ labor_form.labor_name }}</div>
          <div class="col-md-3">{{ labor_form.minutes }}</div>
          <div class="col-md-3">{{ labor_form.price }}</div>
          <div class="col-12">
            <button class="btn btn-outline-light w-100"><i class="bi bi-plus-lg me-1"></i>공임 추가</button>
          </div>
        </form>

        <hr class="my-4">

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead><tr><th>항목</th><th class="text-end">분</th><th class="text-end">금액</th></tr></thead>
            <tbody>
            {% for l in order.labor.all %}
              <tr>
                <td class="fw-semibold">{{ l.labor_name }}</td>
                <td class="text-end">{{ l.minutes|default:"-" }}</td>
                <td class="text-end fw-semibold">{{ l.price|floatformat:0 }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="3" class="text-center text-muted py-4">공임 내역이 없습니다.</td></tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-credit-card"></i><b>결제</b>
      </div>
      <div class="card-body p-4">
        <form method="post" action="/workorders/{{ order.id }}/payments/add/" class="row g-2">
          {% csrf_token %}
          <div class="col-md-4">{{ payment_form.method }}</div>
          <div class="col-md-4">{{ payment_form.amount }}</div>
          <div class="col-md-4">{{ payment_form.paid_at }}</div>
          <div class="col-12">{{ payment_form.note }}</div>
          <div class="col-12">
            <button class="btn btn-outline-light w-100"><i class="bi bi-plus-lg me-1"></i>결제 추가</button>
          </div>
        </form>

        <hr class="my-4">

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead><tr><th>수단</th><th class="text-end">금액</th><th>일시</th></tr></thead>
            <tbody>
            {% for p in order.payments.all %}
              <tr>
                <td><span class="badge badge-soft">{{ p.get_method_display }}</span></td>
                <td class="text-end fw-semibold">{{ p.amount|floatformat:0 }}</td>
                <td class="small-muted">{{ p.paid_at|date:"Y-m-d H:i" }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="3" class="text-center text-muted py-4">결제 내역이 없습니다.</td></tr>
            {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>

  </div>
</div>
{% endblock %}
